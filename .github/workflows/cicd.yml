name: ã‚·ãƒ³ãƒ—ãƒ«Docker CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  test-and-deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: PRæƒ…å ±ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åæŠ½å‡º
        id: get_user
        run: |
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          if [[ "$SOURCE_BRANCH" =~ ^user/(.+)$ ]]; then
            USER_ENV="${BASH_REMATCH[1]}"
            echo "user_env=$USER_ENV" >> $GITHUB_OUTPUT
            echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡: $USER_ENV"
          else
            echo "âŒ å¯¾è±¡å¤–ã®ãƒ–ãƒ©ãƒ³ãƒã§ã™"
            exit 1
          fi

      - name: ã‚·ãƒ³ãƒ—ãƒ«Dockerã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ³ ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...ã€€ "

          # Dockerãƒ“ãƒ«ãƒ‰
          docker build -t php-cicd-test .

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          docker run --rm -v $PWD:/app -w /app php-cicd-test \
            sh -c "
              echo 'ğŸ“¦ ä¾å­˜é–¢ä¿‚ç¢ºèª...'
              composer install --no-progress
              
              echo 'ğŸ” PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯...'
              php -l index.php
              
              echo 'ğŸ›¡ï¸ åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯...'
              if grep -E 'eval|exec|system|shell_exec' index.php; then
                echo 'âŒ å±é™ºãªé–¢æ•°æ¤œå‡º'
                exit 1
              fi
              
              echo 'ğŸ§ª PHPUnitãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ2ã¤ã®ãƒ†ã‚¹ãƒˆï¼‰...'
              composer test
              
              echo 'âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº†'
            "

      - name: EC2ã«ã‚·ãƒ³ãƒ—ãƒ«Dockerãƒ‡ãƒ—ãƒ­ã‚¤
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            USER_ENV="${{ steps.get_user.outputs.user_env }}"

            echo "ğŸ³ $USER_ENV ç’°å¢ƒã«ã‚·ãƒ³ãƒ—ãƒ«Dockerãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹..."

            # æœ€æ–°ã‚³ãƒ¼ãƒ‰å–å¾—
            cd /tmp
            rm -rf simple-php-cicd
            git clone https://github.com/${{ github.repository }}.git simple-php-cicd
            cd simple-php-cicd

            # æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ãƒ»å‰Šé™¤
            docker stop cicd-$USER_ENV 2>/dev/null || true
            docker rm cicd-$USER_ENV 2>/dev/null || true

            # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
            docker build -t php-cicd-$USER_ENV .

            # ãƒãƒ¼ãƒˆç•ªå·æ±ºå®š
            case $USER_ENV in
              alice) PORT=8001 ;;
              bob) PORT=8002 ;;
              charlie) PORT=8003 ;;
              diana) PORT=8004 ;;
              *) PORT=8000 ;;
            esac

            # ã‚·ãƒ³ãƒ—ãƒ«Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
            docker run -d \
              --name cicd-$USER_ENV \
              -p $PORT:80 \
              php-cicd-$USER_ENV

            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            sleep 5
            if curl -f http://localhost:$PORT/ > /dev/null 2>&1; then
              echo "âœ… $USER_ENV ç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            else
              echo "âŒ $USER_ENV ç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
              exit 1
            fi

            echo "ğŸ‰ ã‚·ãƒ³ãƒ—ãƒ«Dockerãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: https://${{ secrets.EC2_HOST }}:$PORT/"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const userEnv = '${{ steps.get_user.outputs.user_env }}';
            const portMap = {alice: 8001, bob: 8002, charlie: 8003, diana: 8004};
            const port = portMap[userEnv] || 8000;
            const url = 'https://${{ secrets.EC2_HOST }}:' + port + '/';

            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ‰ **ã‚·ãƒ³ãƒ—ãƒ«Docker CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†!!**\n\n' +
                    '**ãƒ†ã‚¹ãƒˆçµæœ** âœ…\n' +
                    '- âœ… ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒã§ãƒ“ãƒ«ãƒ‰æˆåŠŸ\n' +
                    '- âœ… PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯é€šé\n' +
                    '- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯é€šé  \n' +
                    '- âœ… 2ã¤ã®PHPUnitãƒ†ã‚¹ãƒˆé€šé\n\n' +
                    '**ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ** ğŸ³\n' +
                    '- ğŸ‘¤ **' + userEnv + 'ã•ã‚“å°‚ç”¨ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒ**\n' +
                    '- ğŸŒ **URL**: ' + url + '\n' +
                    '- âœ¨ **ç¾ã—ã„ãƒ‡ã‚¶ã‚¤ãƒ³ãŒã‚·ãƒ³ãƒ—ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã§å‹•ä½œä¸­ï¼**\n\n' +
                    'ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒã«ã‚ˆã‚Šã€æœ€å°æ§‹æˆã§ç¢ºå®Ÿã«å‹•ä½œã—ã¾ã™ï¼'
            });
