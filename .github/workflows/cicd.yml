name: ã‚·ãƒ³ãƒ—ãƒ«Docker CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  test-and-deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: PRæƒ…å ±ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åæŠ½å‡º
        id: get_user
        run: |
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          if [[ "$SOURCE_BRANCH" =~ ^user/(.+)$ ]]; then
            USER_ENV="${BASH_REMATCH[1]}"
            echo "user_env=$USER_ENV" >> $GITHUB_OUTPUT
            echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡: $USER_ENV"
          else
            echo "âŒ å¯¾è±¡å¤–ã®ãƒ–ãƒ©ãƒ³ãƒã§ã™"
            exit 1
          fi

      - name: å‹•çš„ãƒãƒ¼ãƒˆè¨ˆç®—
        id: calculate_port
        run: |
          USER_ENV="${{ steps.get_user.outputs.user_env }}"
          
          # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ãƒãƒƒã‚·ãƒ¥å€¤è¨ˆç®—ã—ã¦ãƒãƒ¼ãƒˆæ±ºå®š
          HASH=$(echo -n "$USER_ENV" | cksum | cut -f1 -d' ')
          CALCULATED_PORT=$((8001 + HASH % 50))  # 8001-8050ã®ç¯„å›²
          
          echo "calculated_port=$CALCULATED_PORT" >> $GITHUB_OUTPUT
          echo "ğŸ”¢ $USER_ENV â†’ è¨ˆç®—ãƒãƒ¼ãƒˆ: $CALCULATED_PORT"

      - name: ã‚·ãƒ³ãƒ—ãƒ«Dockerã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ³ ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...ã€€ "

          # Dockerãƒ“ãƒ«ãƒ‰
          docker build -t php-cicd-test .

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          docker run --rm -v $PWD:/app -w /app php-cicd-test \
            sh -c "
              echo 'ğŸ“¦ ä¾å­˜é–¢ä¿‚ç¢ºèª...'
              composer install --no-progress
              
              echo 'ğŸ” PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯...'
              php -l index.php
              
              echo 'ğŸ›¡ï¸ åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯...'
              if grep -E 'eval|exec|system|shell_exec' index.php; then
                echo 'âŒ å±é™ºãªé–¢æ•°æ¤œå‡º'
                exit 1
              fi
              
              echo 'ğŸ§ª PHPUnitãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ2ã¤ã®ãƒ†ã‚¹ãƒˆï¼‰...'
              composer test
              
              echo 'âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº†'
            "

- name: EC2ã«ã‚·ãƒ³ãƒ—ãƒ«Dockerãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒãƒ¼ãƒˆæƒ…å ±æ˜ç¤ºï¼‰
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          USER_ENV="${{ steps.get_user.outputs.user_env }}"
          CALCULATED_PORT="${{ steps.calculate_port.outputs.calculated_port }}"
          
          echo "ğŸ³ === ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ ==="
          echo "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒ: $USER_ENV"
          echo "ğŸ”¢ è¨ˆç®—ãƒãƒ¼ãƒˆ: $CALCULATED_PORT"
          echo "========================"
          
          # æœ€æ–°ã‚³ãƒ¼ãƒ‰å–å¾—
          cd /tmp
          rm -rf cicd
          git clone https://github.com/${{ github.repository }}.git cicd
          cd cicd
          
          # ä½¿ç”¨ä¸­ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ãƒ»è¡çªå›é¿
          FINAL_PORT=$CALCULATED_PORT
          COLLISION_COUNT=0
          while netstat -tuln | grep ":$FINAL_PORT " > /dev/null; do
            COLLISION_COUNT=$((COLLISION_COUNT + 1))
            echo "âš ï¸  ãƒãƒ¼ãƒˆ $FINAL_PORT ã¯ä½¿ç”¨ä¸­ï¼ˆè¡çª $COLLISION_COUNT å›ç›®ï¼‰"
            FINAL_PORT=$((FINAL_PORT + 1))
            if [ $FINAL_PORT -gt 8050 ]; then
              FINAL_PORT=8001  # ç¯„å›²ã‚’ãƒ«ãƒ¼ãƒ—
            fi
          done
          
          echo "âœ… æœ€çµ‚æ±ºå®šãƒãƒ¼ãƒˆ: $FINAL_PORT"
          if [ $COLLISION_COUNT -gt 0 ]; then
            echo "ğŸ”„ ãƒãƒ¼ãƒˆè¡çªã‚’ $COLLISION_COUNT å›å›é¿ã—ã¾ã—ãŸ"
          fi
          
          # æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ãƒ»å‰Šé™¤
          if docker ps -a --format '{{.Names}}' | grep -q "^cicd-$USER_ENV$"; then
            echo "ğŸ›‘ æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠ cicd-$USER_ENV ã‚’åœæ­¢ãƒ»å‰Šé™¤ä¸­..."
            docker stop cicd-$USER_ENV 2>/dev/null || true
            docker rm cicd-$USER_ENV 2>/dev/null || true
          fi
          
          # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
          echo "ğŸ”¨ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ä¸­..."
          docker build -t php-cicd-$USER_ENV . > /dev/null 2>&1
          
          # ã‚·ãƒ³ãƒ—ãƒ«Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
          echo "ğŸš€ ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ä¸­..."
          docker run -d \
            --name cicd-$USER_ENV \
            -p $FINAL_PORT:80 \
            php-cicd-$USER_ENV
          
          # Nginxè¨­å®šç”Ÿæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
          echo "âš™ï¸  Nginxè¨­å®šç”Ÿæˆä¸­..."
          sudo tee /etc/nginx/conf.d/user-environments/$USER_ENV.conf > /dev/null <<EOF
          # Auto-generated: $USER_ENV environment
          location /$USER_ENV/ {
              proxy_pass http://127.0.0.1:$FINAL_PORT/;
              proxy_set_header Host \$host;
              proxy_set_header X-Real-IP \$remote_addr;
              proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto \$scheme;
          }
          location /$USER_ENV {
              return 301 /$USER_ENV/;
          }
          EOF
          
          # Nginxè¨­å®šãƒªãƒ­ãƒ¼ãƒ‰
          echo "ğŸ”„ Nginxè¨­å®šãƒªãƒ­ãƒ¼ãƒ‰ä¸­..."
          sudo nginx -t > /dev/null 2>&1 && sudo systemctl reload nginx
          
          # ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ä¿å­˜
          echo $FINAL_PORT > /var/www/html/port_mapping/$USER_ENV
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          echo "ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          sleep 5
          
          if curl -f http://localhost:$FINAL_PORT/ > /dev/null 2>&1; then
            echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
          else
            echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
            echo "ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            echo "   ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹: $(docker ps --filter name=cicd-$USER_ENV --format '{{.Status}}')"
            echo "   ãƒãƒ¼ãƒˆç¢ºèª: $(netstat -tuln | grep $FINAL_PORT || echo 'ãƒãƒ¼ãƒˆæœªä½¿ç”¨')"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ === ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† ==="
          echo "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: $USER_ENV"
          echo "ğŸ”¢ å‰²ã‚Šå½“ã¦ãƒãƒ¼ãƒˆ: $FINAL_PORT"
          echo "ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹URL: http://${{ secrets.EC2_HOST }}/$USER_ENV/"
          echo "ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠå: cicd-$USER_ENV"
          echo "========================"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const userEnv = '${{ steps.get_user.outputs.user_env }}';
            const portMap = {alice: 8001, bob: 8002, charlie: 8003, diana: 8004};
            const port = portMap[userEnv] || 8000;
            const url = 'https://${{ secrets.EC2_HOST }}:' + port + '/';

            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ‰ **ã‚·ãƒ³ãƒ—ãƒ«Docker CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†!!**\n\n' +
                    '**ãƒ†ã‚¹ãƒˆçµæœ** âœ…\n' +
                    '- âœ… ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒã§ãƒ“ãƒ«ãƒ‰æˆåŠŸ\n' +
                    '- âœ… PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯é€šé\n' +
                    '- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯é€šé  \n' +
                    '- âœ… 2ã¤ã®PHPUnitãƒ†ã‚¹ãƒˆé€šé\n\n' +
                    '**ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ** ğŸ³\n' +
                    '- ğŸ‘¤ **' + userEnv + 'ã•ã‚“å°‚ç”¨ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒ**\n' +
                    '- ğŸŒ **URL**: ' + url + '\n' +
                    '- âœ¨ **ç¾ã—ã„ãƒ‡ã‚¶ã‚¤ãƒ³ãŒã‚·ãƒ³ãƒ—ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã§å‹•ä½œä¸­ï¼**\n\n' +
                    'ã‚·ãƒ³ãƒ—ãƒ«Dockerç’°å¢ƒã«ã‚ˆã‚Šã€æœ€å°æ§‹æˆã§ç¢ºå®Ÿã«å‹•ä½œã—ã¾ã™ï¼'
            });
